import java.util.concurrent.atomic.AtomicBoolean;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.Arrays;

public class RicartAgrawala {
    private final int numNodes;
    private final AtomicInteger[] requestTimestamps;
    private final AtomicBoolean[] replyDeferred;
    private final AtomicInteger[] replyCounts;
    private final AtomicInteger localTimestamp;

    public RicartAgrawala(int numNodes) {
        this.numNodes = numNodes;
        this.requestTimestamps = new AtomicInteger[numNodes];
        this.replyDeferred = new AtomicBoolean[numNodes];
        this.replyCounts = new AtomicInteger[numNodes];
        this.localTimestamp = new AtomicInteger(0);

        for (int i = 0; i < numNodes; i++) {
            requestTimestamps[i] = new AtomicInteger(-1);
            replyDeferred[i] = new AtomicBoolean(false);
            replyCounts[i] = new AtomicInteger(0);
        }
    }
    public AtomicInteger[] getReplyCounts() {
    return replyCounts;
}
    

    public void requestCriticalSection(int nodeId) {
        localTimestamp.incrementAndGet();
        requestTimestamps[nodeId].set(localTimestamp.get());

        for (int i = 0; i < numNodes; i++) {
            if (i != nodeId) {
                // Send request message to other nodes
                receiveRequest(nodeId, i);
            }
        }

        while (replyCounts[nodeId].get() < numNodes - 1) {
            // Wait for replies from all other nodes
        }
    }

    public void releaseCriticalSection(int nodeId) {
        replyCounts[nodeId].set(0);
        requestTimestamps[nodeId].set(-1);

        for (int i = 0; i < numNodes; i++) {
            if (replyDeferred[i].get()) {
                replyDeferred[i].set(false);
                // Send reply message to deferred nodes
                receiveReply(nodeId, i);
            }
        }
    }

    private void receiveRequest(int senderId, int receiverId) {
        if (requestTimestamps[receiverId].get() == -1 ||
            requestTimestamps[senderId].get() < requestTimestamps[receiverId].get() ||
            (requestTimestamps[senderId].get() == requestTimestamps[receiverId].get() && senderId < receiverId)) {
            // Send reply message
            receiveReply(receiverId, senderId);
        } else {
            replyDeferred[senderId].set(true);
        }
    }

    private void receiveReply(int senderId, int receiverId) {
        replyCounts[receiverId].incrementAndGet();
    }
     public static void main(String[] args) {
        int numNodes = 5;
        int numRequests = 10;
        RicartAgrawala ra = new RicartAgrawala(numNodes);

        for (int i = 0; i < numRequests; i++) {
            int nodeId = i % numNodes;
            System.out.println("Node " + nodeId + " is requesting the critical section.");
            ra.requestCriticalSection(nodeId);
            System.out.println("Node " + nodeId + " has entered the critical section (SUCCESS).");

            // Print the status of the lists
            System.out.println("Status of lists:");
            for (int j = 0; j < numNodes; j++) {
                System.out.println("Node " + j + ": " + Arrays.toString(ra.getReplyCounts()));
            }

            ra.releaseCriticalSection(nodeId);
            System.out.println("Node " + nodeId + " has released the critical section.");
        }
    }
}